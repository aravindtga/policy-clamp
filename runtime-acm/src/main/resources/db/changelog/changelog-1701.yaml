# ============LICENSE_START=======================================================
# Copyright (C) 2025 OpenInfra Foundation Europe. All rights reserved.
# ================================================================================
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
# ============LICENSE_END=========================================================

databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ONLY_RESERVED_WORDS

  - changeSet:
      id: 1701-1
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: AutomationCompositionRollback
      changes:
        - sql:
            sql: |
              CREATE TABLE AutomationCompositionRollback (
                instanceId VARCHAR(255) NOT NULL,
                compositionId VARCHAR(255) NOT NULL,
                elements TEXT NOT NULL,
                CONSTRAINT PK_AUTOMATIONCOMPOSITION_ROLLBACK PRIMARY KEY (instanceId)
              );

  - changeSet:
      id: 1701-2
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition ALTER COLUMN compositionId SET NOT NULL;

  - changeSet:
      id: 1701-3
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition ALTER COLUMN name SET DEFAULT '';
              UPDATE AutomationComposition SET name = '' WHERE name IS NULL;
              ALTER TABLE AutomationComposition ALTER COLUMN name SET NOT NULL;

  - changeSet:
      id: 1701-4
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition ALTER COLUMN version SET DEFAULT '1.0.0';
              UPDATE AutomationComposition SET version = '1.0.0' WHERE version IS NULL;
              ALTER TABLE AutomationComposition ALTER COLUMN version SET NOT NULL;

  - changeSet:
      id: 1701-5
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition ALTER COLUMN deployState SET DEFAULT 2;
              UPDATE AutomationComposition SET deployState = 2 WHERE deployState IS NULL;
              ALTER TABLE AutomationComposition ALTER COLUMN deployState SET NOT NULL;

  - changeSet:
      id: 1701-6
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition ALTER COLUMN lockState SET DEFAULT 4;
              UPDATE AutomationComposition SET lockState = 4 WHERE lockState IS NULL;
              ALTER TABLE AutomationComposition ALTER COLUMN lockState SET NOT NULL;

  - changeSet:
      id: 1701-7
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition ALTER COLUMN subState SET DEFAULT 0;
              UPDATE AutomationComposition SET subState = 0 WHERE subState IS NULL;
              ALTER TABLE AutomationComposition ALTER COLUMN subState SET NOT NULL;

  - changeSet:
      id: 1701-8
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE AutomationComposition SET lastMsg = now() WHERE lastMsg IS NULL;
              ALTER TABLE AutomationComposition ALTER COLUMN lastMsg SET NOT NULL;

  - changeSet:
      id: 1701-9
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN definition_name SET DEFAULT '';
              UPDATE AutomationCompositionElement SET definition_name = '' WHERE definition_name IS NULL;
              ALTER TABLE AutomationCompositionElement ALTER COLUMN definition_name SET NOT NULL;

  - changeSet:
      id: 1701-10
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN definition_version SET DEFAULT '0.0.0';
              UPDATE AutomationCompositionElement SET definition_version = '0.0.0' WHERE definition_version IS NULL;
              ALTER TABLE AutomationCompositionElement ALTER COLUMN definition_version SET NOT NULL;

  - changeSet:
      id: 1701-11
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN deployState SET DEFAULT 2;
              UPDATE AutomationCompositionElement SET deployState = 2 WHERE deployState IS NULL;
              ALTER TABLE AutomationCompositionElement ALTER COLUMN deployState SET NOT NULL;

  - changeSet:
      id: 1701-12
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN lockState SET DEFAULT 4;
              UPDATE AutomationCompositionElement SET lockState = 4 WHERE lockState IS NULL;
              ALTER TABLE AutomationCompositionElement ALTER COLUMN lockState SET NOT NULL;

  - changeSet:
      id: 1701-13
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN subState SET DEFAULT 0;
              UPDATE AutomationCompositionElement SET subState = 0 WHERE subState IS NULL;
              ALTER TABLE AutomationCompositionElement ALTER COLUMN subState SET NOT NULL;

  - changeSet:
      id: 1701-14
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN outProperties SET DEFAULT '{}';
              ALTER TABLE AutomationCompositionElement ALTER COLUMN outProperties SET NOT NULL;

  - changeSet:
      id: 1701-15
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionElement ALTER COLUMN properties SET DEFAULT '{}';
              ALTER TABLE AutomationCompositionElement ALTER COLUMN properties SET NOT NULL;

  - changeSet:
      id: 1701-16
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: ac_composition_fk
                foreignKeyTableName: AutomationComposition
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationComposition
                ADD CONSTRAINT ac_composition_fk
                FOREIGN KEY (compositionId)
                REFERENCES AutomationCompositionDefinition (compositionId)
                ON UPDATE RESTRICT
                ON DELETE RESTRICT;

  - changeSet:
      id: 1701-17
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN name SET DEFAULT '';
              UPDATE AutomationCompositionDefinition SET name = '' WHERE name IS NULL;
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN name SET NOT NULL;

  - changeSet:
      id: 1701-18
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN version SET DEFAULT '1.0.0';
              UPDATE AutomationCompositionDefinition SET version  = '1.0.0' WHERE version IS NULL;
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN version SET NOT NULL;

  - changeSet:
      id: 1701-19
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN state SET DEFAULT 0;
              UPDATE AutomationCompositionDefinition SET state = 0 WHERE state IS NULL;
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN state SET NOT NULL;

  - changeSet:
      id: 1701-20
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN serviceTemplate SET DEFAULT '';
              UPDATE AutomationCompositionDefinition SET serviceTemplate = '' WHERE serviceTemplate IS NULL;
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN serviceTemplate SET NOT NULL;

  - changeSet:
      id: 1701-21
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE AutomationCompositionDefinition SET lastMsg = now() WHERE lastMsg IS NULL;
              ALTER TABLE AutomationCompositionDefinition ALTER COLUMN lastMsg SET NOT NULL;

  - changeSet:
      id: 1701-22
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE NodeTemplateState ALTER COLUMN nodeTemplate_name SET DEFAULT '';
              UPDATE NodeTemplateState SET nodeTemplate_name  = '' WHERE nodeTemplate_name IS NULL;
              ALTER TABLE NodeTemplateState ALTER COLUMN nodeTemplate_name SET NOT NULL;

  - changeSet:
      id: 1701-23
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE NodeTemplateState ALTER COLUMN nodeTemplate_version SET DEFAULT '1.0.0';
              UPDATE NodeTemplateState SET nodeTemplate_version = '1.0.0' WHERE nodeTemplate_version IS NULL;
              ALTER TABLE NodeTemplateState ALTER COLUMN nodeTemplate_version SET NOT NULL;

  - changeSet:
      id: 1701-24
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE NodeTemplateState ALTER COLUMN outProperties SET DEFAULT '{}';
              UPDATE NodeTemplateState SET outProperties = '{}' WHERE outProperties IS NULL;
              ALTER TABLE NodeTemplateState ALTER COLUMN outProperties SET NOT NULL;

  - changeSet:
      id: 1701-25
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE NodeTemplateState ALTER COLUMN state SET DEFAULT 0;
              UPDATE NodeTemplateState SET state = 0 WHERE state IS NULL;
              ALTER TABLE NodeTemplateState ALTER COLUMN state SET NOT NULL;

  - changeSet:
      id: 1701-26
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: mb_identificationId_index
      changes:
        - sql:
            sql: CREATE INDEX mb_identificationId_index ON Message(identificationId);

  - changeSet:
      id: 1701-27
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE ParticipantReplica SET lastMsg = now() WHERE lastMsg IS NULL;
              ALTER TABLE ParticipantReplica ALTER COLUMN lastMsg SET NOT NULL;

  - changeSet:
      id: 1701-28
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE ParticipantReplica ALTER COLUMN participantId SET DEFAULT '';
              ALTER TABLE ParticipantReplica ALTER COLUMN participantId SET NOT NULL;

  - changeSet:
      id: 1701-29
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE ParticipantReplica ALTER COLUMN participantState SET DEFAULT 1;
              UPDATE ParticipantReplica SET participantState = '1' WHERE participantState IS NULL;
              ALTER TABLE ParticipantReplica ALTER COLUMN participantState SET NOT NULL;

  - changeSet:
      id: 1701-30
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE ParticipantSupportedAcElements ALTER COLUMN participantId SET DEFAULT '';
              ALTER TABLE ParticipantSupportedAcElements ALTER COLUMN participantId SET NOT NULL;

  - changeSet:
      id: 1701-31
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE ParticipantSupportedAcElements ALTER COLUMN typeName SET DEFAULT '';
              UPDATE ParticipantSupportedAcElements SET typeName = '' WHERE typeName IS NULL;
              ALTER TABLE ParticipantSupportedAcElements ALTER COLUMN typeName SET NOT NULL;

  - changeSet:
      id: 1701-32
      author: policy
      changes:
        - sql:
            sql: |
              ALTER TABLE ParticipantSupportedAcElements ALTER COLUMN typeVersion SET DEFAULT '1.0.0';
              UPDATE ParticipantSupportedAcElements SET typeVersion = '1.0.0' WHERE typeVersion IS NULL;
              ALTER TABLE ParticipantSupportedAcElements ALTER COLUMN typeVersion SET NOT NULL;
